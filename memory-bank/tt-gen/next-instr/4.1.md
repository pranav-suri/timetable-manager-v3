# Next Step Instructions: Step 4.2 - Implement Timetable Validation and Quality Metrics

**For**: Next Agent
**Created**: 2025-10-30
**Previous Step**: 4.1 - Implement Chromosome Decoder

## Context: What Was Just Completed

Step 4.1 successfully created a `decoder.ts` module that separates result interpretation from job orchestration. We now have functions to convert a chromosome into `LectureSlot` records for database persistence (`chromosomeToLectureSlots`) and into a rich JSON format for API responses (`chromosomeToJSON`). The `jobManager` has been refactored to use this new module.

## What Step 4.2 Needs to Accomplish

Now that we can generate a timetable and decode it, we need to be able to formally verify its quality. Step 4.2 is about creating a `validator.ts` module that will analyze a generated timetable (in its chromosome form) and produce a detailed quality report.

### Core Objectives

1.  **Create a `validator.ts` Module**: This new file will contain functions for validating a final solution and calculating various quality metrics.
2.  **Implement Post-Generation Validation**: Create a function that takes a chromosome and re-runs all the constraint checkers from `constraints.ts`. This serves as a final verification step and will be used to generate a detailed report of any remaining soft violations.
3.  **Calculate Quality Metrics**: Implement functions to calculate key performance indicators (KPIs) for the timetable. These are higher-level metrics than the simple soft constraint penalties. Based on the research document, these should include:
    - Room utilization percentage.
    - Teacher load balance (e.g., standard deviation of hours taught per teacher).
    - Student schedule compactness (e.g., average idle time per student group).
4.  **Generate a Quality Report**: Create a function that combines the validation results and the quality metrics into a single, structured JSON object. This report will be stored in the `Job` record and displayed in the UI.

## Implementation Strategy

1.  **Create `src/server/services/timetableGenerator/validator.ts`**.
2.  **Implement `validateSolution`**: This function will take a `Chromosome` and `GAInputData`. It should call `evaluateChromosome` from `constraints.ts` to get a full list of all hard and soft violations. It should return a structured object containing these violation details.
3.  **Implement Metric Calculators**: Create separate functions for each quality metric (e.g., `calculateRoomUtilization`, `calculateTeacherLoadBalance`). These functions will need to iterate over the chromosome and use the `lookupMaps` to aggregate the necessary data.
4.  **Implement `generateQualityReport`**: This main function will call the validation and metric functions and assemble their results into a single `QualityReport` object (you may need to define this type in `types.ts`).
5.  **Integrate with `jobManager.ts`**: In `jobManager.ts`, after the GA run is complete, call `generateQualityReport` and store its output in the `result` field of the `Job` record, along with the other final statistics.

## Gotchas & Important Considerations

- **Efficiency**: Some metric calculations might require iterating over the chromosome multiple times. Try to be efficient, but clarity is more important than micro-optimization at this stage.
- **Data Aggregation**: You will need to use `Map` objects extensively to aggregate data (e.g., counting hours per teacher, or slots used per room).
- **Define Metrics Clearly**: The definition of a metric can be ambiguous. For example, is "Room Utilization" based on hours used, or capacity used? Refer to the research document and make a clear choice, documenting it in the code.
